# ZK (Groth16)

This folder contains the Groth16 zkSNARK setup for Arbiter.

- compile a circuit
- run the trusted setup locally
- generate proofs
- **export a Solidity verifier**

**circom + snarkjs**

Interface - (`contracts/src/interfaces/IVerifier.sol`) and an adapter (`Groth16VerifierAdapter`).

## Prereqs

- Node.js 18+
- `circom` compiler

### Install circom

From the `circom` repo (requires Rust toolchain):

```bash
cargo install --git https://github.com/iden3/circom --tag v2.1.8
```

## Install JS deps

```bash
cd zk
npm install
```

## Build (compile circuit + trusted setup + export Solidity verifier)

```bash
cd zk
./scripts/build_groth16.sh
```

This will generate:

- `zk/build/**` (wasm, zkey, vk, etc.)
- `contracts/src/verifiers/PolicyGroth16Verifier.sol` (Solidity verifier, generated by snarkjs)

## Prove (generate proof for given public inputs)

Example:

```bash
cd zk
node scripts/prove.mjs \
  --vault 0x0000000000000000000000000000000000000001 \
  --nonce 0 \
  --deadline 0 \
  --allowBitmap 31 \
  --capsBps 5000,5000,5000,0,0 \
  --allocations 5000,3000,2000,0,0
```

The script prints a JSON blob containing:

- `policyHash` (field element)
- `a`, `b`, `c` (Groth16 proof points)
- `publicInputs` (for `Vault.executeWithProof`)

## Protocol IDs (bitmap + allocations index)

We use a fixed vector of 5 protocols (N=5). Bit `i` in `allowBitmap` corresponds to protocol `i`,
and `allocations[i]` is the allocation (bps) for that protocol.

- `0`: Ondo Finance
- `1`: AGNI Finance
- `2`: Stargate
- `3`: Mantle Rewards
- `4`: INIT Capital

Example: `allowBitmap = 0b10101 = 21` allowlists Ondo, Stargate, INIT (0,2,4).

## End-to-end test

Foundry includes an e2e test that runs proof generation via `vm.ffi`.

Run:

```bash
cd contracts
RUN_ZK_E2E=1 forge test
```


